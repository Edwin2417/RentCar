{% extends "base.html" %}

{% block title %}Tipos de Vehiculos | Indexing Car Rental{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-white">Tipos de Vehiculos</h2>
        <!-- Botón para abrir el modal -->
        <a href="#" class="btn btn-danger rounded-pill px-4" data-bs-toggle="modal"
            data-bs-target="#creartipoVehiculoModal">Crear Tipo de Vehiculo</a>
    </div>

    <table class="table table-hover align-middle" style="background-color: #121212; color: white; width: 100%;">
        <thead>
            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.5);">
                <th class="py-3">ID</th>
                <th class="py-3">Descripción</th>
                <th class="py-3">Estado</th>
                <th class="py-3">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for tipoVehiculo in tipoVehiculos %}
            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.5);">
                <td class="py-3">{{ tipoVehiculo.identificador }}</td>
                <td class="py-3">{{ tipoVehiculo.descripcion }}</td>
                <td class="py-3">
                    {% if tipoVehiculo.estado == 1 %}
                    <span class="badge bg-success rounded-pill px-3 py-2">Activo</span>
                    {% else %}
                    <span class="badge bg-danger rounded-pill px-3 py-2">Inactivo</span>
                    {% endif %}
                </td>
                <td class="py-3">
                    <div class="acciones-btns">
                        <button class="btn btn-warning text-white btn-editar" data-id="{{ tipoVehiculo.identificador }}"
                            data-descripcion="{{ tipoVehiculo.descripcion }}" data-estado="{{ tipoVehiculo.estado }}">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="btn btn-danger text-white btn-eliminar" data-id="{{ tipoVehiculo.identificador }}">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.5);">
                <td colspan="4" class="text-center py-4">No hay Tipos de Vehiculos disponibles</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Toast de Éxito -->
<div id="toastSuccess" class="toast align-items-center text-bg-success border-0 position-fixed bottom-95 end-0 m-3"
    role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
    </div>
</div>

<!-- Toast de Error -->
<div id="toastDanger" class="toast align-items-center text-bg-danger border-0 position-fixed bottom-95 end-0 m-3"
    role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
    </div>
</div>

<!-- Toast de Advertencia (Validaciones) -->
<div id="toastWarning" class="toast align-items-center text-bg-warning border-0 position-fixed bottom-95 end-0 m-3"
    role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
    </div>
</div>



<!-- Modal para Crear tipoVehiculo -->
<div class="modal fade" id="creartipoVehiculoModal" tabindex="-1" aria-labelledby="creartipoVehiculoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #2c2b2b; color: white;">
            <div class="modal-header">
                <h5 class="modal-title" id="creartipoVehiculoModalLabel">Crear Nuevo Tipo de Vehiculo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="creartipoVehiculoForm">
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <input type="text" class="form-control" id="descripcion" name="descripcion" required>
                    </div>
                    <div class="mb-3">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-control" id="estado" name="estado" required>
                            <option value="1">Activo</option>
                            <option value="2">Inactivo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-danger" id="guardartipoVehiculo">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editartipoVehiculoModal" tabindex="-1" aria-labelledby="editartipoVehiculoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #2c2b2b; color: white;">
            <div class="modal-header">
                <h5 class="modal-title" id="editartipoVehiculoModalLabel">Editar Tipo de Vehiculo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editartipoVehiculoForm">
                    <div class="mb-3">
                        <label for="editDescripcion" class="form-label">Descripción</label>
                        <input type="text" class="form-control" id="editDescripcion" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEstado" class="form-label">Estado</label>
                        <select class="form-control" id="editEstado" required>
                            <option value="1">Activo</option>
                            <option value="2">Inactivo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-warning" id="editartipoVehiculo">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<div id="modalConfirmacion" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #2c2b2b; color: white;">
            <div class="modal-header">
                <h5 class="modal-title">Confirmación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar este Tipo de Vehiculo?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirmarEliminar" class="btn btn-danger">Eliminar</button>
            </div>
        </div>
    </div>
</div>




<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Función para CREAR una nueva tipoVehiculo
        document.getElementById('guardartipoVehiculo').addEventListener('click', function () {
            const descripcion = document.getElementById('descripcion').value.trim();
            const estado = document.getElementById('estado').value;

            if (!descripcion) {
                mostrarToast('warning', 'La descripción es obligatoria.');
                return;
            }

            fetch('/api/tipoVehiculo/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    descripcion: descripcion,
                    estado: parseInt(estado)
                })
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Error al guardar la tipoVehiculo.');
                    }
                })
                .then(data => {
                    mostrarToast('success', data.message || 'tipoVehiculo agregada exitosamente.');
                    document.getElementById("creartipoVehiculoForm").reset(); // Limpiar formulario

                    // Ocultar modal después de éxito
                    const modal = bootstrap.Modal.getInstance(document.getElementById('creartipoVehiculoModal'));
                    modal.hide();

                    setTimeout(() => location.reload(), 1000); // Recargar después de 1s
                })
                .catch(error => {
                    mostrarToast('danger', error.message);
                });
        });

        // Función para manejar la EDICIÓN de una tipoVehiculo
        document.querySelectorAll(".btn-editar").forEach(button => {
            button.addEventListener("click", function () {
                const id = this.dataset.id;
                const descripcion = this.dataset.descripcion;
                const estado = this.dataset.estado;

                // Llenar el modal con los datos actuales
                document.getElementById("editDescripcion").value = descripcion;
                document.getElementById("editEstado").value = estado;
                document.getElementById("editartipoVehiculo").dataset.id = id;

                // Mostrar el modal de edición
                const modal = new bootstrap.Modal(document.getElementById("editartipoVehiculoModal"));
                modal.show();
            });
        });

        // Guardar cambios de la tipoVehiculo editada
        document.getElementById("editartipoVehiculo").addEventListener("click", function () {
            const id = this.dataset.id;
            const descripcion = document.getElementById("editDescripcion").value.trim();
            const estado = document.getElementById("editEstado").value;

            if (!descripcion) {
                mostrarToast('warning', 'La descripción es obligatoria.');
                return;
            }

            fetch(`/api/tipoVehiculo/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    descripcion: descripcion,
                    estado: parseInt(estado) // Elimina parseInt, ya que Django espera un ID directamente
                })
            })

                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        mostrarToast('success', data.message);
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        mostrarToast('danger', 'Error al actualizar la tipoVehiculo.');
                    }
                })
                .catch(error => mostrarToast('danger', 'Error en la solicitud.'));
        });

        // Función para ELIMINAR una tipoVehiculo
        document.querySelectorAll(".btn-eliminar").forEach(button => {
            button.addEventListener("click", function () {
                const id = this.dataset.id;

                // Guardar el ID en un atributo del botón "Eliminar"
                const confirmarBtn = document.getElementById("confirmarEliminar");
                confirmarBtn.dataset.id = id;

                // Mostrar el modal
                const modal = new bootstrap.Modal(document.getElementById("modalConfirmacion"));
                modal.show();

                // Manejar la confirmación de eliminación
                confirmarBtn.onclick = function () {
                    fetch(`/api/tipoVehiculo/${id}`, {
                        method: "DELETE",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                mostrarToast('success', data.message);
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                mostrarToast('danger', 'Error al eliminar la tipoVehiculo.');
                            }
                        })
                        .catch(error => mostrarToast('danger', 'Error en la solicitud.'));
                };
            });
        });
    });

    // Función para mostrar los toasts de notificación
    function mostrarToast(tipo, mensaje) {
        const toastEl = document.getElementById(`toast${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        toastEl.querySelector('.toast-body').innerText = mensaje;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

</script>

<style>
    .table th,
    .table td {
        text-align: center;
        vertical-align: middle;
    }

    .btn {
        transition: all 0.2s ease-in-out;
    }

    .btn:hover {
        transform: scale(1.1);
    }

    .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.2) !important;
    }

    .table-hover tbody tr:hover td {
        color: white !important;
    }

    .badge {
        font-size: 0.85rem;
        font-weight: 500;
    }

    .acciones-btns {
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .acciones-btns .btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}